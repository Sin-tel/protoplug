require("include/protoplug")
local Line = require("include/dsp/fdelay_line")

local function Allpass()
	local a1, a2 = 0, 0
	local x1, x2 = 0, 0
	local y0, y1, y2 = 0, 0, 0

	local public = {
		update = function(w, r)
			a1 = -2 * r * math.cos(w)
			a2 = r * r
		end,
		process = function(x0)
			y2, y1 = y1, y0
			-- y0 = a2 * x0 + a1 * x1 + x2 - a1 * y1 - a2 * y2
			y0 = a2 * (x0 - y2) + a1 * (x1 - y1) + x2
			x2, x1 = x1, x0
			return y0
		end,
	}

	return public
end

-- stylua: ignore start
-- local r = { 0.9909917965216243, 0.9909917965216243, 0.9909547416988103, 0.990917688265172, 0.9908806362206748, 0.9908065362993117, 0.990732441934315, 0.9906583531253733, 0.9905472303290105, 0.9904361200321817, 0.9902879924117567, 0.9901028641288468, 0.9899547864938819, 0.9897697206854006, 0.9895476875208329, 0.9892517210189387, 0.9889928231763373, 0.9886600544041543, 0.988253489577777, 0.9878470925230937, 0.9873301024753344, 0.9867764859361481, 0.9860756856789559, 0.9853016983939179, 0.9842706644246235, 0.983056908714798, 0.981514304126433, 0.9794246618112824, 0.9764993784635272, 0.9719098904508959, 0.9633361543947336, 0.9315743249536605 }
-- local w = { 0.0038013651244948946, 0.011404095373484684, 0.019022533742823623, 0.02667238835286087, 0.034353659203596426, 0.04208205441537943, 0.04987328210855905, 0.05772734228313528, 0.06565994305945727, 0.07368679255787416, 0.08182359889873514, 0.0901017783227385, 0.09852133082988421, 0.1070822564201723, 0.11581597133430106, 0.12476959993331796, 0.13395885033757216, 0.14339943066741279, 0.15315417340423648, 0.1632544947887415, 0.17374751918197534, 0.18469607906533458, 0.19617871504056505, 0.2082896758297616, 0.2211703345160666, 0.23500918854366992, 0.25002615159745967, 0.2665982185658155, 0.28532229802200526, 0.30728225027012035, 0.33494425020497787, 0.3804192586157742 }
-- local r = { 0.9804684228852568, 0.9803884037760645, 0.9802017180851963, 0.9799350863169987, 0.9795352755698643, 0.9790823552751702, 0.9784166791177349, 0.9776184694736704, 0.9765817777554915, 0.9752277756931295, 0.9734783474311592, 0.9710714486369306, 0.9675908002377505, 0.9621317252140968, 0.9517469558508872, 0.9131227617352767 }
-- local w = { 0.011388387253135531, 0.03421228612045405, 0.057193266191264094, 0.08044128430800973, 0.10408200543348417, 0.1282253864101315, 0.15302850844144322, 0.17869557709195835, 0.20544650604656498, 0.23361116583259534, 0.2636136756994765, 0.29608236046117464, 0.3320539560607338, 0.37336631257900477, 0.4242134981492113, 0.505267399150838 }

-- c2 ~65hz, b = 0.000034
-- 8
-- local r = { 0.9519089917853478, 0.9511619382736993, 0.9495801536829552, 0.9469299607105172, 0.9426283344212799, 0.9352584332185481, 0.9206947411257497, 0.8653881972509546 }
-- local w = { 0.024646040827820206, 0.07433082549218943, 0.12524084354379256, 0.17838141468497531, 0.23519768598785973, 0.29821866482865944, 0.3730207339313234, 0.48671610901848883 }

-- 4
-- local r = { 0.9122205450853272, 0.9068201969263706, 0.8916140949389838, 0.8264730990892032 }
-- local w = { 0.03861055981821674, 0.11832927059016546, 0.2076613510157955, 0.336090942990466 }


-- C5 ~ 523.2511 Hz
-- local r = { 0.7373125420782725, 0.7215881342490954, 0.6787170553743607, 0.5183189758176425 }
-- local w = { 0.12860238129851118, 0.3949963942997877, 0.6967965105680538, 1.1427971716415395 }

-- local r = { 0.8191607256468455, 0.816182164276902, 0.8097779568288186, 0.7990248870306312, 0.7816718783532287, 0.7529099514001321, 0.6982638347599697, 0.5213319925220931 }
-- local w = { 0.08395990326621988, 0.2534191055928766, 0.42774782522777055, 0.6110615897023798, 0.8093294847493822, 1.0328089129567741, 1.3043394813122235, 1.735574509257506 }

-- C6 ~ 1046.502 Hz
local r = { 0.6141450660881228, 0.5926942955124878, 0.5359734318943108, 0.3490188371405183 }
local w = { 0.20720581552567005, 0.6371213613616237, 1.1268848457278482, 1.861066682726885 }

-- stylua: ignore end

local f_base = 1046.502

local n = #w
print(n)

local l = 1025
local feedback = 0.9
local mix = 1.0

stereoFx.init()
function stereoFx.Channel:init()
	self.ap = {}
	for i = 1, n do
		-- print()
		self.ap[i] = Allpass()
		self.ap[i].update(w[i], r[i])
	end

	self.delay = Line(4000)
end

function stereoFx.Channel:processBlock(samples, smax)
	for k = 0, smax do
		local s_in = samples[k]

		local s = self.delay.goBack(l)

		for i = 1, n do
			s = self.ap[i].process(s)
		end

		self.delay.push(s * feedback + s_in)

		samples[k] = mix * s + (1 - mix) * s_in
	end
end

params = plugin.manageParams({
	{
		name = "mix",
		min = 0,
		max = 1,
		default = 1,
		changed = function(val)
			mix = val
		end,
	},
	{
		name = "freq",
		min = f_base * 0.5,
		max = f_base * 2.5,
		default = f_base,
		changed = function(val)
			l = 44100 / val
		end,
	},
	{
		name = "decay",
		min = 0.0,
		max = 10.0,
		default = 5,
		changed = function(val)
			feedback = 1.0 - math.exp(-val)
		end,
	},
})
params.resetToDefaults()
